<template>
    <b-card no-body>
        <b-card-header class="pb-50 d-flex">
            <h5>
                {{ $t("Filters") }}
            </h5>
            <b-dropdown
                variant="link"
                no-caret
                dropleft
                :right="$store.state.appConfig.isRTL"
                v-if="$can('generar', 'reportes_actas')"
            >
                <template #button-content>
                    <feather-icon
                        icon="MoreVerticalIcon"
                        size="16"
                        class="align-middle text-body"
                    />
                </template>

                <!-- v-if="$can('generar', 'reportes_partes')" -->
                <b-dropdown-item
                    id="toggle-btn"
                    v-b-modal.modal-reports
                    
                >
                    <feather-icon icon="FileTextIcon" />
                    <span class="align-middle ml-50">{{ $t("Reports") }}</span>
                </b-dropdown-item>
                
              
                <actas-reports-modal 
                    :parroquias-options="parroquiasOptions"
                    :recintos-report-options="recintosReportOptions"
                    @fetch-recintos-report-options="fetchRecintosReportOptions"
                />  

            </b-dropdown>

            <div v-if="ultimaActualizacion">
                <small>Generado el:</small>
                <strong class="mr-1">
                    {{ formatearDateTime(ultimaActualizacion)}}
                </strong>
                <b-button
                    v-ripple.400="'rgba(113, 102, 240, 0.15)'"
                    variant="outline-primary"
                    size="sm"
                    @click="$emit('refetch-data')"
                    title="Recargar resultados"
                >
                    <feather-icon
                        icon="RefreshCcwIcon"
                    />
                </b-button>
                <b-button
                    v-ripple.400="'rgba(113, 102, 240, 0.15)'"
                    variant="outline-primary"
                    size="sm"
                    @click="$emit('reset-interval')"
                    title="Recargar cada 15 segundos automÃ¡ticamente"
                >
                    <feather-icon
                        :icon="runInterval ? 'PauseIcon' : 'PlayIcon'"
                    />
                </b-button>
            </div>
        </b-card-header>
        <b-card-body>
            <b-row>
                <!-- @input="val => $emit('update:parroquiaFilter', val)" -->
                <b-col cols="12" md="3" class="mb-md-0 mb-2">
                    <label>{{ ("Parroquia") }}</label>
                    <v-select
                        :dir="$store.state.appConfig.isRTL ? 'rtl' : 'ltr'"
                        :value="parroquiaFilter"
                        :options="parroquiasOptions"
                        class="filter-select-1"
                        label="nombre"
                        :reduce="val => val.id.toString()"
                        @input="selectRecinto"
                        multiple
                        placeholder="Seleccione la parroquia"
                        :readonly="true"
                    >
                        <template #option="{ nombre, countActas}">
                            {{ nombre }}
                            <small>
                                <b-badge variant="dark"> {{ countActas }} </b-badge>
                            </small>
                        </template>
                        <template #selected-option="{ nombre, countActas}">
                            {{ nombre }}
                            &nbsp;
                            <small>
                                <b-badge variant="dark"> {{ countActas }} </b-badge>
                            </small>
                        </template>
                    </v-select>
                </b-col>
                <b-col cols="12" md="5" class="mb-md-0 mb-2 pl-0">
                   <label>{{ ("Recinto") }}</label>
                    <v-select
                        :dir="$store.state.appConfig.isRTL ? 'rtl' : 'ltr'"
                        :value="recintoFilter"
                        :options="recintosOptions"
                        class="w-100"
                        label="nombre"
                        :reduce="val => val.id.toString()"
                        @input="selectJunta"
                        placeholder="Seleccione el recinto"
                    >
                        <template #option="{ nombre, countActas}">
                            {{ nombre }}
                            <small>
                                <b-badge variant="dark"> {{ countActas }} </b-badge>
                            </small>
                        </template>
                        <template #selected-option="{ nombre, countActas}">
                            {{ nombre }}
                            &nbsp;
                            <small>
                                <b-badge variant="dark"> {{ countActas }} </b-badge>
                            </small>
                        </template>
                    </v-select>
                </b-col>
                <b-col cols="12" md="2" class="mb-md-0 mb-2 pl-0">
                   <label>{{ ("Junta") }}</label>
                    <v-select
                        :dir="$store.state.appConfig.isRTL ? 'rtl' : 'ltr'"
                        :value="juntaFilter"
                        :options="juntasOptions"
                        class="w-100"
                        label="codigo"
                        :reduce="val => val.id.toString()"
                        @input="val => $emit('update:juntaFilter', val)"
                        placeholder="Seleccione la junta"
                    >
                        <template #option="{ para_select, actas_count}">
                            {{ para_select }}
                            <small>
                                <b-badge variant="dark"> {{ actas_count }} </b-badge>
                            </small>
                        </template>
                        <template #selected-option="{ para_select, actas_count}">
                            {{ para_select }}
                            &nbsp;
                            <small>
                                <b-badge variant="dark"> {{ actas_count }} </b-badge>
                            </small>
                        </template>
                    </v-select>
                </b-col>

                <b-col cols="12" md="2" class="mb-md-0 mb-2 pl-0">
                   <label>{{ ("Actas") }}</label>
                    <v-select
                        :dir="$store.state.appConfig.isRTL ? 'rtl' : 'ltr'"
                        :value="estadoFilter"
                        :options="estadosOptions"
                        class="w-100"
                        label="label"
                        :reduce="val => val.value.toString()"
                        @input="val => $emit('update:estadoFilter', val)"
                        placeholder="Seleccione el estado"
                    >
                        <template #option="{ label, actas_count}">
                            {{ label }}
                            <small>
                                <b-badge variant="dark"> {{ actas_count }} </b-badge>
                            </small>
                        </template>
                        <template #selected-option="{ label, actas_count}">
                            {{ label }}
                            &nbsp;
                            <small>
                                <b-badge variant="dark"> {{ actas_count }} </b-badge>
                            </small>
                        </template>
                    </v-select>
                </b-col>


            </b-row>
        </b-card-body>
    </b-card>
</template>
<script>
import { BCard, BCardHeader, BCardBody, BRow, BCol, BBadge, BButton, BDropdown, BDropdownItem } from "bootstrap-vue";
import vSelect from "vue-select";
import Ripple from 'vue-ripple-directive';

import ActasReportsModal from "../actas-reports/ActasReportsModal";

import useActasReports from './useActasReports'
import moment from 'moment';

export default {
    components: {
        BRow,
        BCol,
        BCard,
        BCardHeader,
        BCardBody,
        vSelect,
        BBadge,
        BButton,
        BDropdown, 
        BDropdownItem,
        ActasReportsModal
    },
    directives: {
        Ripple,
    },
    props: {
       parroquiaFilter: {
            type: [Array, null],
            default: null
        },
        recintoFilter: {
            type: [String, null],
            default: null
        },
        juntaFilter: {
            type: [String, null],
            default: null
        },
        parroquiasOptions: {
            type: Array,
            required: true,
        },
        recintosOptions: {
            type: Array,
            required: true,
        },
        juntasOptions: {
            type: Array,
            required: true,
        },
        estadosOptions: {
            type: Array,
            required: true,
        },
        estadoFilter: {
            type: [String, null],
            default: null
        },
        
        ultimaActualizacion:{
            type: Date|String,
            required: false
        },
        runInterval:{
            type: Boolean,
            required: false
        }
    },
    methods: {
        refetchData() {
            this.$emit("refetch-data");
        }
    },

    setup(props , { emit }) {

        const selectRecinto = (parroquiaId) => {
            emit('update:parroquiaFilter', parroquiaId);
            emit("fetch-recintos-options", parroquiaId);
        };

        const selectJunta = (recintoId) => {
            emit('update:recintoFilter', recintoId);
            emit("fetch-juntas-options", recintoId);
        };

          const{
            fetchRecintosReportOptions,
            recintosReportOptions,
        } = useActasReports()

        const formatearDateTime = (item) =>{
			moment.locale('es')
			let date = moment(item).format("D MMMM YYYY, h:mm:ss a");
			return date
		}




        return {
            selectRecinto,
            selectJunta,

            fetchRecintosReportOptions,
            recintosReportOptions,
            formatearDateTime,
        };

    }
};
</script>
